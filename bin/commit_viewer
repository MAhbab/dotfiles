#!/usr/bin/env bash
# commit_explorer_subset.sh
#
# Browse *specific* commits and drill down into file-level diffs.
# Accepts commit hashes as positional args or from stdin.

set -euo pipefail

#── Verify we’re inside a repo ────────────────────────────────────────────────
if ! git rev-parse --is-inside-work-tree &>/dev/null; then
  echo "Error: not inside a Git repository." >&2
  exit 1
fi
REPO_ROOT=$(git rev-parse --show-toplevel)

#── Collect and format commits for fzf ───────────────────────────────────────
declare -a LINES

# If commit hashes are passed as arguments or piped via stdin, use them.
# Otherwise, fall back to listing all commits from `git log`.
if [[ $# -gt 0 ]]; then
  for c in "$@"; do
    if git cat-file -e "${c}^{commit}" 2>/dev/null; then
      line=$(git log -1 --date=short --pretty='%h %ad %an %s' "$c")
      LINES+=("$line")
    else
      echo "Warning: '$c' is not a valid commit; skipping." >&2
    fi
  done
elif ! [[ -t 0 ]]; then
  while IFS= read -r c; do
    if [[ -n "$c" ]] && git cat-file -e "${c}^{commit}" 2>/dev/null; then
      line=$(git log -1 --date=short --pretty='%h %ad %an %s' "$c")
      LINES+=("$line")
    else
      # When reading from a pipe, it might be noisy to warn for every line
      # that isn't a commit. Silently ignore invalid lines.
      :
    fi
  done
else
  # No args and stdin is a TTY, so list all commits.
  while IFS= read -r line; do
    LINES+=("$line")
  done < <(git log --date=short --pretty='%h %ad %an %s')
fi

if [[ ${#LINES[@]} -eq 0 ]]; then
  echo "No commits to display." >&2
  exit 1
fi

#── Interactive commit-then-file picker ───────────────────────────────────────
COMMIT=$(
  printf '%s\n' "${LINES[@]}" |
  fzf --reverse \
      --prompt="Choose commit> " \
      --preview='git diff-tree --no-commit-id --name-only $(echo {} | awk "{print \$1}") -r' |
  awk '{print $1}'
)

[[ -z $COMMIT ]] && exit 0   # user cancelled

FILE_SELECTION=$(
  git -C "$REPO_ROOT" diff-tree --no-commit-id --name-only "$COMMIT" -r |
  fzf --reverse \
      --prompt="Choose file> " \
      --preview="git -C $REPO_ROOT show --color=always $COMMIT -- {}"
)

[[ -z $FILE_SELECTION ]] && exit 0   # user cancelled

git -C "$REPO_ROOT" show --color=always "$COMMIT" -- "$FILE_SELECTION"
